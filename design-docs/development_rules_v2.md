# 相次相続控除額 計算シミュレーター（家系図表示版）
# 開発ルール (Development Rules) v2.0

**文書バージョン:** 2.0  
**作成日:** 2025年6月18日  
**作成者:** Manus AI

## 1. 概要

本文書は、相次相続控除額計算シミュレーター（家系図表示版）の開発における規約とガイドラインを定めるものです。開発者はこのルールに従って実装を行い、一貫性のある高品質なアプリケーションを構築することを目指します。

## 2. コーディング規約

### 2.1 HTML規約

- HTML5の標準仕様に準拠すること
- セマンティックなタグを適切に使用すること（`<header>`, `<main>`, `<section>`, `<article>`, `<footer>`など）
- アクセシビリティに配慮したマークアップを行うこと（適切な`aria-*`属性、`role`属性の使用）
- 入力フォームには適切な`label`要素と`for`属性を使用すること
- SVG要素は適切な名前空間と属性を持つこと
- コンポーネントごとに論理的な構造化を行うこと

### 2.2 CSS規約

- BEM（Block, Element, Modifier）命名規則に従うこと
- メディアクエリを使用したレスポンシブデザインを実装すること
- CSS変数（カスタムプロパティ）を活用して一貫性のあるスタイルを維持すること
- 印刷用スタイルシートを別途用意すること
- アニメーションは`prefers-reduced-motion`に配慮すること
- コメントを適切に記述し、複雑なスタイルの意図を明確にすること

### 2.3 JavaScript規約

- ES6+の機能を積極的に活用すること
- 厳格モード（`'use strict';`）を使用すること
- モジュールパターンを採用し、グローバル名前空間の汚染を避けること
- 関数は単一責任の原則に従い、一つの機能に集中すること
- イベントリスナーは適切に管理し、メモリリークを防止すること
- 非同期処理にはPromiseまたはasync/awaitを使用すること
- コメントはJSDocスタイルで記述すること

### 2.4 命名規則

- 変数名・関数名：キャメルケース（例：`calculateDeduction`）
- 定数：大文字のスネークケース（例：`MAX_YEARS`）
- クラス名：パスカルケース（例：`FamilyTree`）
- ファイル名：ケバブケース（例：`family-tree.js`）
- CSSクラス名：BEM形式（例：`family-tree__person--deceased`）

## 3. アーキテクチャ規約

### 3.1 ファイル構成

```
souzoku-simulator/
├── index.html           # メインHTML
├── css/
│   ├── style.css        # メインスタイル
│   ├── family-tree.css  # 家系図関連スタイル
│   └── print.css        # 印刷用スタイル
├── js/
│   ├── main.js          # メインスクリプト
│   ├── calculator.js    # 計算ロジック
│   ├── family-tree.js   # 家系図描画ロジック
│   ├── date-utils.js    # 日付処理ユーティリティ
│   └── form-handler.js  # フォーム処理
└── assets/
    └── icons/           # アイコン画像
```

### 3.2 モジュール構成

- **計算モジュール**：相次相続控除の計算ロジックを担当
- **家系図モジュール**：家系図の描画と操作を担当
- **フォームモジュール**：入力フォームの処理と検証を担当
- **日付モジュール**：日付の処理と計算を担当
- **ストレージモジュール**：データの保存と読み込みを担当
- **UIモジュール**：ユーザーインターフェースの操作を担当

### 3.3 データフロー

1. ユーザー入力 → フォームモジュール
2. フォームモジュール → 日付モジュール（日付計算）
3. フォームモジュール → 計算モジュール（控除額計算）
4. 計算結果 → 家系図モジュール（表示更新）
5. 全データ → ストレージモジュール（保存）

## 4. UI/UX規約

### 4.1 レイアウト規約

- コンテンツは論理的なセクションに分割すること
- 視覚的階層を明確にし、重要な情報を目立たせること
- 十分な余白を確保し、コンテンツの可読性を高めること
- フォームの入力順序は論理的な流れに従うこと
- タブインデックスを適切に設定し、キーボードナビゲーションを最適化すること

### 4.2 家系図表示規約

- 家系図は中央に配置し、十分な表示領域を確保すること
- 人物アイコンは性別によって色分けすること（男性：青系、女性：赤系）
- 死亡した人物には「×」マークを明確に表示すること
- 相続放棄・相続欠格の場合は適切なビジュアル表現を用いること
- 相次相続控除額は吹き出し形式で表示し、視認性を確保すること
- 家系図の各要素はSVGで実装し、拡大縮小に対応すること

### 4.3 フォーム規約

- 入力フィールドには適切なプレースホルダーとラベルを設定すること
- 必須項目は視覚的に明示すること
- 入力エラーは即時フィードバックし、修正方法を示すこと
- 数値入力フィールドは3桁区切りで表示すること
- 日付入力には適切なカレンダーピッカーを提供すること
- 和暦/西暦の切り替えオプションを提供すること

### 4.4 アクセシビリティ規約

- WCAG 2.1 AAレベルに準拠すること
- 適切なARIA属性を使用すること
- キーボード操作を完全にサポートすること
- 色だけに依存しない情報伝達を行うこと
- テキストと背景のコントラスト比は4.5:1以上を確保すること
- スクリーンリーダー対応のために適切な代替テキストを提供すること

## 5. 計算ロジック規約

### 5.1 相次相続控除の計算規約

- 計算式：A × (C / B) × (D / C) × (10 - E) / 10
  - A: 前回の相続で納めた相続税額
  - B: 前回に取得した財産の価額
  - C: 今回の相続財産の総額
  - D: 相続人が今回取得した財産の価額
  - E: 前回の相続からの経過年数（1年未満切り捨て）
- 計算結果は小数点以下を切り捨てること
- 各種条件チェックを実装すること：
  - 各入力値が0以上であること
  - B, C, Dが0の場合は分母がゼロになるため、エラー処理を行うこと
  - Eが10以上の場合は控除額が0になること

### 5.2 日付計算規約

- 和暦から西暦への変換を正確に行うこと
  - 平成：1989年1月8日〜2019年4月30日
  - 令和：2019年5月1日〜
- 経過年数の計算は、日付の差分から年数を算出し、1年未満の端数を切り捨てること
- 日付の妥当性チェックを実装すること（存在しない日付、未来の日付など）

### 5.3 複数相続人の計算規約

- 各法定相続人ごとに個別に相次相続控除額を計算すること
- 同じA, B, C, Eの値を使用し、Dのみ各相続人の値を使用すること
- 相続ステータスが「法定相続人」の場合のみ計算を行うこと
- 計算結果の合計値も算出し、表示すること

## 6. テスト規約

### 6.1 単体テスト

- 計算ロジックの正確性を検証するテストケースを作成すること
- 日付変換・計算の正確性を検証するテストケースを作成すること
- エッジケース（ゼロ値、最大値、負値など）のテストを実施すること

### 6.2 統合テスト

- フォーム入力から計算結果表示までの一連の流れをテストすること
- 家系図の描画と相続情報の表示を検証すること
- データの保存と読み込み機能をテストすること

### 6.3 UI/UXテスト

- レスポンシブデザインの動作を各種デバイスサイズでテストすること
- キーボード操作の完全性をテストすること
- スクリーンリーダーでの読み上げ内容を検証すること
- 各ブラウザ（Chrome, Firefox, Safari, Edge）での表示を確認すること

## 7. ドキュメント規約

### 7.1 コードドキュメント

- 関数には適切なJSDocコメントを記述すること
- 複雑なロジックには説明コメントを追加すること
- 公開APIには使用方法の例を記述すること

### 7.2 ユーザードキュメント

- 各入力項目の詳細な説明を提供すること
- 相次相続控除の概要と適用条件を説明すること
- 計算式の意味と根拠を解説すること
- よくある質問（FAQ）セクションを用意すること

## 8. デプロイ規約

### 8.1 ビルド規約

- HTML, CSS, JavaScriptファイルの最小化を行うこと
- 画像ファイルは適切に最適化すること
- 依存ライブラリは必要最小限に抑えること

### 8.2 Vercelデプロイ規約

- Vercelの設定ファイル（vercel.json）を適切に構成すること
- キャッシュ設定を最適化すること
- カスタムドメイン設定を可能にすること
- 環境変数を適切に管理すること

## 9. パフォーマンス規約

### 9.1 読み込み最適化

- 重要なCSSはインラインで提供し、初期表示を高速化すること
- JavaScriptは非同期読み込みを基本とすること
- 画像は適切なフォーマットと圧縮率で提供すること
- Webフォントの読み込みを最適化すること

### 9.2 実行最適化

- 計算処理は非同期で行い、UIブロッキングを防止すること
- 家系図の描画処理は最適化し、スムーズな操作感を実現すること
- 入力値の変更時は適切なデバウンス処理を行うこと
- メモリ使用量を監視し、リークを防止すること

## 10. セキュリティ規約

### 10.1 入力検証

- すべてのユーザー入力は適切にバリデーションを行うこと
- XSS攻撃を防止するため、出力時にエスケープ処理を行うこと
- 数値入力は適切な範囲内に制限すること

### 10.2 データ保護

- ローカルストレージに保存するデータは最小限に抑えること
- センシティブな情報（個人名など）は暗号化して保存すること
- データのエクスポート/インポート時はフォーマット検証を行うこと

## 11. アクセシビリティ規約

### 11.1 キーボード操作

- すべての機能はキーボードのみで操作可能にすること
- フォーカス順序は論理的な流れに従うこと
- フォーカス状態は視覚的に明確に表示すること

### 11.2 スクリーンリーダー対応

- 適切なARIA属性を使用すること
- 動的に変更される内容は適切に通知すること
- 家系図の情報はテキストでも提供すること

### 11.3 視覚的アクセシビリティ

- テキストサイズの変更に対応すること
- 高コントラストモードに対応すること
- アニメーションは`prefers-reduced-motion`に応じて制御すること

## 12. 国際化規約

### 12.1 日本語対応

- 日本語の適切な表示を確保すること
- 和暦表示に対応すること
- 日本の数値表記（3桁区切りのカンマ）に対応すること

### 12.2 将来の多言語対応

- テキストリソースは外部化し、将来の多言語対応を容易にすること
- 日付や数値のフォーマットは各地域の慣習に対応できるようにすること

## 13. 拡張性規約

### 13.1 コード拡張性

- 機能追加が容易な設計を心がけること
- インターフェースを明確に定義し、実装の詳細を隠蔽すること
- 設定値は定数として外部化し、変更を容易にすること

### 13.2 機能拡張性

- 将来的な機能追加（複数パターン比較、税制改正対応など）を考慮した設計を行うこと
- APIとの連携を想定したデータ構造を設計すること
- プラグイン機構を検討し、サードパーティによる拡張を可能にすること
